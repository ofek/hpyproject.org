<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>hpy 0.0.4: Third public release | HPy</title>
<link href="../../../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../../../rss.xml">
<link rel="canonical" href="https://hpyproject.org/blog/posts/2022/06/hpy-0.0.4-third-public-release/">
<link rel="icon" href="../../../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../../../assets/css/tipuesearch.css">
<meta name="author" content="fangerer">
<link rel="prev" href="../../../2021/10/hpy-0.0.3-second-public-release/" title="hpy 0.0.3: Second public release" type="text/html">
<link rel="next" href="../../07/dusseldorf-sprint-2022/" title="Dusseldorf PyPy/HPy/other sprint Sept 19-23, 2022" type="text/html">
<meta property="og:site_name" content="HPy">
<meta property="og:title" content="hpy 0.0.4: Third public release">
<meta property="og:url" content="https://hpyproject.org/blog/posts/2022/06/hpy-0.0.4-third-public-release/">
<meta property="og:description" content="HPy 0.0.4 is out! The third official HPy release comes with many new features
and was again made available on PyPI.
Major highlights of the release are a bunch of new API functions (e.g.
HPyErr_Except">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-06-02T09:15:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../../../index.html">
                    <image id="toplogo" src="../../../../../images/hpy-logo.svg" width="75px;" alt="HPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> <a href="https://hpy.readthedocs.io/">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../../../blog">Index</a> </li>  
                    <li> <a href="../../../../../categories">Tags</a> </li>  
                    <li> <a href="../../../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../../../rss.xml">RSS feed</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Searchâ€¦" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">hpy 0.0.4: Third public release</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../../../authors/fangerer/">fangerer</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2022-06-02T09:15:00Z" itemprop="datePublished" title="2022-06-02 09:15">2022-06-02 09:15</time></a>
            </p>
                <p class="commentline">            <a href="#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>HPy 0.0.4 is out! The third official HPy release comes with many new features
and was again made available on PyPI.</p>
<p>Major highlights of the release are a bunch of new API functions (e.g.
<code>HPyErr_ExceptionMatches</code>, <code>HPyErr_WarnEx</code>, <code>HPy_Contains</code>, and more),
Python 3.10 support, better support for native fields (<code>HPyField</code>) and global
variables (<code>HPyGlobal</code>), new debug mode features (detect invalid raw data
pointer usage, detect invalid closing of argument handles, detect return of
invalid handles).</p>
<p>Great news too is that we are now able to provide two more non-trivial projects
that have been (partially) migrated to HPy. This is,
<a href="https://github.com/hpyproject/kiwi-hpy/">Kiwisolver</a>
and <a href="https://github.com/hpyproject/matplotlib-hpy/">Matplotlib</a>.</p>
<!--TEASER_END-->

<h2>What is HPy?</h2>
<p>HPy provides a new API for extending Python in C. In other words, you use
<code>#include &lt;hpy.h&gt;</code> instead of <code>#include &lt;Python.h&gt;</code>. For more info, look at
the
<a href="https://docs.hpyproject.org/en/0.0.4/overview.html">official documentation</a>.</p>
<h2>Installation</h2>
<p>HPy 0.0.4 is best tested on Linux systems but there is also initial support for
Windows (both <code>x86_64</code>).
For CPython, you need to install it manually, using pip:</p>
<div class="code"><pre class="code literal-block">$ pip install <span class="nv">hpy</span><span class="o">==</span><span class="m">0</span>.0.4
</pre></div>


<p><a href="https://pypy.org">PyPy</a> and <a href="https://graalvm.org/python/">GraalPython</a> already
come with intrinsic HPy support, so no installation is necessary. HPy 0.0.4 will
be included in the next release of both. In the meantime, you can download a
nightly or dev build:</p>
<ul>
<li>
<p><a href="http://buildbot.pypy.org/nightly/">PyPy nightly builds</a></p>
</li>
<li>
<p><a href="https://github.com/graalvm/graalvm-ce-dev-builds/releases/">GraalVM CE dev builds</a></p>
</li>
</ul>
<p>To check the version of HPy which is shipped with those, you can either use
<code>pip</code> or <code>hpy.universal.get_version()</code>:</p>
<div class="code"><pre class="code literal-block">$ pypy -m pip show hpy
Name: hpy
Version: <span class="m">0</span>.0.4
...

$ graalpython -m pip show hpy
Name: hpy
Version: <span class="m">0</span>.0.4
...

$ pypy -c <span class="s1">'import hpy.universal; print(hpy.universal.get_version()[0])'</span>
<span class="m">0</span>.0.4

$ graalpython -c <span class="s1">'import hpy.universal; print(hpy.universal.get_version()[0])'</span>
<span class="m">0</span>.0.4
</pre></div>


<h2>API</h2>
<p>We are constantly working on the HPy API and keep adding functions that are
missing. We've added following API functions to the new release:</p>
<ul>
<li>
<code>HPyErr_SetFromErrnoWithFilename</code>, <code>HPyErr_SetFromErrnoWithFilenameObjects</code>
</li>
<li><code>HPyErr_ExceptionMatches</code></li>
<li><code>HPyErr_WarnEx</code></li>
<li><code>HPyErr_WriteUnraisable</code></li>
<li><code>HPy_Contains</code></li>
<li><code>HPyLong_AsVoidPtr</code></li>
<li><code>HPyLong_AsDouble</code></li>
<li>
<code>HPyUnicode_AsASCIIString</code>, <code>HPyUnicode_DecodeASCII</code>
</li>
<li>
<code>HPyUnicode_AsLatin1String</code>, <code>HPyUnicode_DecodeLatin1</code>
</li>
<li>
<code>HPyUnicode_DecodeFSDefault</code>, <code>HPyUnicode_DecodeFSDefaultAndSize</code>
</li>
<li><code>HPyUnicode_ReadChar</code></li>
</ul>
<p>For an overview of the current API, please refer to the public API declaration
in <a href="https://github.com/hpyproject/hpy/blob/0.0.4/hpy/tools/autogen/public_api.h#L116-L440"><code>public_api.h</code></a>,
which is used to autogenerate parts of the HPy code and is a reliable list of
all the supported functions. Also have a look at additional helpers in
<a href="https://github.com/hpyproject/hpy/blob/0.0.4/hpy/devel/include/hpy/inline_helpers.h"><code>inline_helpers.h</code></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The HPy API is still considered in alpha status and it's subject to change
between versions.</p>
</div>
<h2>Debug Mode</h2>
<p>We again improved HPy's debug mode and added following new features:</p>
<h3>Enable Debug Mode via Environment Variable</h3>
<p>The debug mode can now be enabled using environment variable <code>HPY_DEBUG</code>. It is
possible to enable the debug mode for all HPy extensions or it is also possible
to enable it just for certain extensions by enumerating them.</p>
<p>Example:</p>
<div class="code"><pre class="code literal-block">$ <span class="c1"># enable debug mode for all HPy extensions</span>
$ <span class="nv">HPY_DEBUG</span><span class="o">=</span><span class="m">1</span> python3 my_application.py

$ <span class="c1"># enable debug mode just for ujson_hpy and piconumpy_hpy</span>
$ <span class="nv">HPY_DEBUG</span><span class="o">=</span>ujson_hpy,piconumpy_hpy python3 my_application.py
</pre></div>


<h3>Detect Invalid Use of Raw Data Pointers</h3>
<p>Some API functions return a raw data pointer from an object. For example:</p>
<div class="code"><pre class="code literal-block"><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="o">*</span><span class="w"> </span><span class="n">HPyUnicode_AsUTF8AndSize</span><span class="p">(</span><span class="n">HPyContext</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">HPy_ssize_t</span><span class="w"> </span><span class="o">*</span><span class="n">size</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>returns a raw data pointer to the UTF8 representation of a Python unicode
object. HPy doesn't expose the internal representation of the unicode object, so
the Python implementation may use an arbitrary internal representation. This
means that the UTF8 representation is just temporarily created for this API call
and so the raw data must be released at some point. The contract here is that
the raw data pointer is valid as long as the corresponding handle is valid.</p>
<p>Example:</p>
<div class="code"><pre class="code literal-block"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s_hello_world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Hello, World!"</span><span class="p">;</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="n">HPyContext</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">HPy</span><span class="w"> </span><span class="n">h_unicode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HPyUnicode_FromString</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">s_hello_word</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">HPy_ssize_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HPyUnicode_AsUTF8AndSize</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">h_unicode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* closing 'h_unicode' is, of course, correct */</span><span class="w"></span>
<span class="w">    </span><span class="n">HPy_Close</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">h_unicode</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* raw data pointer 'res' may have become invalid when closing</span>
<span class="cm">       'h_unicode' */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="n">HPyContext</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* accessing 's' will cause a fatal error in debug mode (on supported</span>
<span class="cm">    systems) */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s_hello_world</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>It is easy to forget about this resriction and if the raw data pointer is used
after the handle was closed, it may point to garbage. If the debug mode is
enabled, it will make the underlying memory inaccessible and every access to the
pointer will then cause a crash of the application. This is currently only
implemented for Linux systems. We use a different strategy on other systems and
fill the pointer with some marker bytes that make it easy to detect.</p>
<h3>Detect Incorrect Closing of Argument Handles</h3>
<p>HPy functions that are called from Python receive handles that are owned by the
caller. This means that those handles must not be closed by the callee but it
is, of course, possible to erroneously call <code>HPy_Close</code> on them. For example:</p>
<div class="code"><pre class="code literal-block"><span class="n">HPyDef_METH</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="s">"foo"</span><span class="p">,</span><span class="w"> </span><span class="n">foo_impl</span><span class="p">,</span><span class="w"> </span><span class="n">HPyFunc_O</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">doc</span><span class="o">=</span><span class="s">"closing argument"</span><span class="p">)</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">foo_impl</span><span class="p">(</span><span class="n">HPyContext</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// error: 'arg' is owned by the caller</span>
<span class="w">    </span><span class="n">HPy_Close</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HPy_Dup</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">h_None</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<h3>Detect Invalid Handles Returned from Function</h3>
<p>A common problem when returning handles is that the author may easily forget to
create a new handle. The debug mode now detects situations like the following:</p>
<div class="code"><pre class="code literal-block"><span class="n">HPyDef_METH</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="s">"foo"</span><span class="p">,</span><span class="w"> </span><span class="n">foo_impl</span><span class="p">,</span><span class="w"> </span><span class="n">HPyFunc_NOARGS</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">doc</span><span class="o">=</span><span class="s">"returns arg w/o dupping it"</span><span class="p">)</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">foo_impl</span><span class="p">(</span><span class="n">HPyContext</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">HPy</span><span class="w"> </span><span class="n">self</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// should be: return HPy_Dup(ctx, self);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<h2>Examples</h2>
<p>Besides the known examples, this is HPy's 
<a href="https://github.com/hpyproject/hpy/tree/0.0.4/proof-of-concept">"proof of concept" package</a>, 
<a href="https://github.com/hpyproject/ultrajson-hpy/tree/hpy-0.0.4"><code>ultrajson-hpy</code></a>,
<a href="https://github.com/hpyproject/piconumpy/tree/hpy-0.0.4"><code>piconumpy</code></a>, we are
excited to present two new packages we have migrated to HPy:</p>
<ul>
<li>
<p><a href="https://github.com/hpyproject/kiwi-hpy/">Kiwi</a> 
    is an efficient C++ implementation of the Cassowary constraint solving
    algorithm.</p>
</li>
<li>
<p><a href="https://github.com/hpyproject/matplotlib-hpy/">Matplotlib</a>
    is a comprehensive library for creating static, animated, and interactive
    visualizations in Python.
    Since Matplotlib also has a dependency to NumPy, the migration is not fully
    finished but luckily, HPy provides the legacy compatibility API such that we
    can still call legacy C API functions from HPy.</p>
</li>
</ul>
<p>We are still cleaning these ports up and will write another blog post about the
ports and open them for discussion with the project owners.</p>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../../../2021/10/hpy-0.0.3-second-public-release/" rel="prev" title="hpy 0.0.3: Second public release">Previous post</a>
            </li>
            <li class="next">
                <a href="../../07/dusseldorf-sprint-2022/" rel="next" title="Dusseldorf PyPy/HPy/other sprint Sept 19-23, 2022">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                      <div data-title="hpy 0.0.4: Third public release" id="utterances-thread"></div>
        <script src="https://utteranc.es/client.js" repo="hpyproject/hpyproject.org" issue-term="title" label="Comments" theme="github-light" crossorigin="anonymous"></script></section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The HPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/hpyproject/hpyproject.github.io/">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/blog/posts/2022/09/hpy_sprint_2022_report/" class="listtitle">HPy Sprint Status Update and Feedback Session</a>
      </li>
      <li>
        <a href="/blog/posts/2022/09/hpy_on_graal_and_mpl/" class="listtitle">HPy on GraalPy and Matplotlib/HPy</a>
      </li>
      <li>
        <a href="/blog/posts/2022/07/dusseldorf-sprint-2022/" class="listtitle">Dusseldorf PyPy/HPy/other sprint Sept 19-23, 2022</a>
      </li>
      <li>
        <a href="/blog/posts/2022/06/hpy-0.0.4-third-public-release/" class="listtitle">hpy 0.0.4: Third public release</a>
      </li>
      <li>
        <a href="/blog/posts/2021/10/hpy-0.0.3-second-public-release/" class="listtitle">hpy 0.0.3: Second public release</a>
      </li>
      <li>
        <a href="/blog/posts/2021/07/hpy-0.0.2-first-public-release/" class="listtitle">hpy 0.0.2: First public release</a>
      </li>
      <li>
        <a href="/blog/posts/2021/05/hpy-irc-moves-to-libera-chat/" class="listtitle">#hpy IRC moves to Libera.Chat</a>
      </li>
      <li>
        <a href="/blog/posts/2021/05/hpy-python-language-summit/" class="listtitle">HPy @ Python Language Summit</a>
      </li>
      <li>
        <a href="/blog/posts/2021/05/may-status-update/" class="listtitle">HPy Status Update</a>
      </li>
      <li>
        <a href="/blog/posts/2021/03/hello-hpy/" class="listtitle">Hello, HPy</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2021/">2021</a> (6)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (4)
            </li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div>
    <img src="../../../../../images/hpy-logo.svg" alt="PyPy Logo">
</div>
  <div class="logotext">
    Â Contents Â© 2022 <a href="mailto:hpy-dev@python.org">The HPy Team</a>
    Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> 
  </div>
  <div style="margin-left: auto">
  <a href="../../../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>
